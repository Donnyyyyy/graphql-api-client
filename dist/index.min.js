"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),_client=require("./client.min"),_client2=_interopRequireDefault(_client);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var GraphqlClient=function(){function q(e){var t=e.apiUrl,n=void 0===t?"/graphql":t,r=e.reqParams,i=void 0===r?{}:r,u=e.schemaUrl,a=void 0===u?"/schema.json":u,o=e.baseQueryName,y=void 0===o?"Query":o,l=e.baseMutationName,c=void 0===l?"Mutation":l,s=e.onlyQueries,f=void 0===s?null:s,p=e.onlyMutations,d=void 0===p?null:p,h=e.synced,m=void 0===h?[]:h,_=e.onData,v=void 0===_?function(){}:_,g=e.onError,T=void 0===g?function(){}:g;_classCallCheck(this,q),this.apiUrl=n,this.params=i,this.onData=v,this.onError=T,this._client=(0,_client2.default)(this.apiUrl,this.params),this._init(a,y,c,f,d,m)}return _createClass(q,[{key:"_typeQueryBuilders",get:function(){var n=this;return{SCALAR:function(){return""},NON_NULL:function(e){return e.ofType?n._queryType(e.ofType):""},ENUM:function(){return""},UNION:function(e){return"{ "+(e=n._getType(e.name)).possibleTypes.reduce(function(e,t){return e+" ... on "+t.name+" "+n._queryType(t)+" "},"")+" }"},OBJECT:function(e,t){return"{ "+(t?n._getType(e.name).fields.filter(function(e){return 0<=t.indexOf(e.name)}):n._getType(e.name).fields).reduce(function(e,t){return e+(t.name+" ")+n._queryType(t.type)},"")+" }\t"},LIST:function(e){return n._queryType(e.ofType)}}}},{key:"_typeValidators",get:function(){return{SCALAR:function(e){return"object"!==(void 0===e?"undefined":_typeof(e))},NON_NULL:function(e){return null!=e},ENUM:function(e){return!0},UNION:function(e){return!0},OBJECT:function(e){return"object"===(void 0===e?"undefined":_typeof(e))},LIST:function(e){return Array.isArray(e)}}}},{key:"go",get:function(){var t=this;return function(){return t._client.apply(t,arguments).then(function(e){return t.onData(e),e}).catch(function(e){throw t.onError(e),e})}}}]),_createClass(q,[{key:"mutate",value:function(t,e){var n=this,r=function(){try{return n.go(n.mutations[t].result.queryBuilder(e,void 0),e)}catch(e){console.error("Trying to perform mutation "+t+" that does not exist. ("+e+")")}};return this.pendingInit?this.pendingInit.then(r):r()}},{key:"query",value:function(t,e,n){var r=this,i=function(){try{return r.go(r.queries[t].result.queryBuilder(e,n),e)}catch(e){console.error("Trying to query "+t+" that does not exist.")}};return this.pendingInit?this.pendingInit.then(i):i()}},{key:"sync",value:function(e){var t="{ "+e.name+" "+this._queryType(e.type)+" }";return this.go(t,{})}},{key:"syncAll",value:function(e){var n=this;if(0<e.length){var t="{ "+e.reduce(function(e,t){return e+" "+t.name+" "+n._queryType(t.type)+" "},"")+" }";return this.go(t,{})}}},{key:"_init",value:function(e,i,u,a,o,t){var y=this;this.synced=t,this.pendingInit=fetch(e).then(function(e){return e.json()}).then(function(e){return y.schema=e}).then(function(){var e=y._getType(i),t=y._getType(u),n=e.fields.filter(function(e){return null===a||0<=a.indexOf(e.name)});y.queries=y._updateApiQueries(n);var r=t.fields.filter(function(e){return null===o||0<=o.indexOf(e.name)});y.mutations=y._updateApiMutations(r),y._updateSyncList(n).then(function(e){return y.syncAll(e)}),delete y.pendingInit})}},{key:"_getType",value:function(t){return this.schema.data.__schema.types.filter(function(e){return e.name===t})[0]}},{key:"_queryType",value:function(e,t){return this._typeQueryBuilders[e.kind](e,t)}},{key:"_updateSyncList",value:function(n){var r=this;return new Promise(function(e,t){e(n.filter(function(e){return e.name in r.synced}))})}},{key:"_getTypeName",value:function(e,t){var n="";if("SCALAR"===e.kind)n=e.name;else{if("NON_NULL"===e.kind)return this._getTypeName(e.ofType,!0);n="LIST"===e.kind?"["+this._getTypeName(e.ofType)+"]":e.name}return n+(t?"!":"")}},{key:"_prepareApiQuery",value:function(n,r){var i=this;return{args:n.args.map(function(e){return{name:e.name,validator:i._typeValidators[e.type.kind]}}),result:{query:(r?"mutation":"query")+(0<n.args.length?"("+n.args.map(function(e){return"$"+e.name+":"+i._getTypeName(e.type)})+")":"")+" {\n\t\t\t"+n.name+(0<n.args.length?"("+n.args.map(function(e){return e.name+":$"+e.name})+")":"")+" "+this._queryType(n.type)+"\n\t\t\t}",queryBuilder:function(t,e){return(r?"mutation":"query")+(0<n.args.length?"("+n.args.filter(function(e){return e.name in t}).map(function(e){return"$"+e.name+":"+i._getTypeName(e.type)})+")":"")+" {\n\t\t\t\t"+n.name+(0<n.args.length?"("+n.args.map(function(e){return e.name+":$"+e.name})+")":"")+" "+i._queryType(n.type,e)+"\n\t\t\t}"},type:n.type}}}},{key:"_updateApiQueries",value:function(e){var t={},n=!0,r=!1,i=void 0;try{for(var u,a=e[Symbol.iterator]();!(n=(u=a.next()).done);n=!0){var o=u.value;t[o.name]=this._prepareApiQuery(o)}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return t}},{key:"_updateApiMutations",value:function(e){var t={},n=!0,r=!1,i=void 0;try{for(var u,a=e[Symbol.iterator]();!(n=(u=a.next()).done);n=!0){var o=u.value;t[o.name]=this._prepareApiQuery(o,!0)}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return t}}]),q}();exports.default=GraphqlClient;