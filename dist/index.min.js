'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},_createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,'value'in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_client=require('./client.min'),_client2=_interopRequireDefault(_client);Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var GraphqlClient=function(){function a(_ref){var _ref$apiUrl=_ref.apiUrl,b=void 0===_ref$apiUrl?'/graphql':_ref$apiUrl,_ref$reqParams=_ref.reqParams,c=void 0===_ref$reqParams?{}:_ref$reqParams,_ref$schemaUrl=_ref.schemaUrl,d=void 0===_ref$schemaUrl?'/schema.json':_ref$schemaUrl,_ref$baseQueryName=_ref.baseQueryName,e=void 0===_ref$baseQueryName?'Query':_ref$baseQueryName,_ref$baseMutationName=_ref.baseMutationName,f=void 0===_ref$baseMutationName?'Mutation':_ref$baseMutationName,_ref$onlyQueries=_ref.onlyQueries,g=void 0===_ref$onlyQueries?null:_ref$onlyQueries,_ref$onlyMutations=_ref.onlyMutations,h=void 0===_ref$onlyMutations?null:_ref$onlyMutations,_ref$synced=_ref.synced,j=void 0===_ref$synced?[]:_ref$synced,_ref$onData=_ref.onData,k=void 0===_ref$onData?function(){}:_ref$onData,_ref$onError=_ref.onError,l=void 0===_ref$onError?function(){}:_ref$onError;_classCallCheck(this,a),this.apiUrl=b,this.params=c,this.onData=k,this.onError=l,this._client=(0,_client2.default)(this.apiUrl,this.params),this._init(d,e,f,g,h,j)}return _createClass(a,[{key:'_typeQueryBuilders',get:function get(){var b=this;return{SCALAR:function SCALAR(){return''},NON_NULL:function NON_NULL(c){return c.ofType?b._queryType(c.ofType):''},ENUM:function ENUM(){return''},UNION:function UNION(c){return c=b._getType(c.name),'{ '+c.possibleTypes.reduce(function(d,e){return d+(' ... on '+e.name+' '+b._queryType(e)+' ')},'')+' }'},OBJECT:function OBJECT(c,d){var e=d?b._getType(c.name).fields.filter(function(g){return 0<=d.indexOf(g.name)}):b._getType(c.name).fields,f=e.reduce(function(g,h){return g+(h.name+' '+b._queryType(h.type))},'');return'{ '+f+' }\t'},LIST:function LIST(c){return b._queryType(c.ofType)}}}},{key:'_typeValidators',get:function get(){return{SCALAR:function SCALAR(b){return'object'!==('undefined'==typeof b?'undefined':_typeof(b))},NON_NULL:function NON_NULL(b){return null!==b&&void 0!==b},ENUM:function ENUM(){return!0},UNION:function UNION(){return!0},OBJECT:function OBJECT(b){return'object'===('undefined'==typeof b?'undefined':_typeof(b))},LIST:function LIST(b){return Array.isArray(b)}}}},{key:'go',get:function get(){var b=this;return function(){return b._client.apply(b,c).then(function(d){return b.onData(d),d}).catch(function(d){throw b.onError(d),d})}}}]),_createClass(a,[{key:'mutate',value:function mutate(b,c){var e=this,d=function(){try{return e.go(e.mutations[b].result.queryBuilder(c,void 0),c)}catch(f){console.error('Trying to perform mutation '+b+' that does not exist. ('+f+')')}};return this.pendingInit?this.pendingInit.then(d):d()}},{key:'query',value:function query(b,c,d){var f=this,e=function(){try{return f.go(f.queries[b].result.queryBuilder(c,d),c)}catch(g){console.error('Trying to query '+b+' that does not exist.')}};return this.pendingInit?this.pendingInit.then(e):e()}},{key:'sync',value:function sync(b){var c='{ '+b.name+' '+this._queryType(b.type)+' }';return this.go(c,{})}},{key:'syncAll',value:function syncAll(b){var d=this;if(0<b.length){var c='{ '+b.reduce(function(e,f){return e+(' '+f.name+' '+d._queryType(f.type)+' ')},'')+' }';return this.go(c,{})}}},{key:'_init',value:function _init(b,c,d,e,f,g){var h=this;this.synced=g,this.pendingInit=fetch(b).then(function(j){return j.json()}).then(function(j){return h.schema=j}).then(function(){var k=h._getType(c),l=h._getType(d),m=k.fields.filter(function(n){return null===e||0<=e.indexOf(n.name)});h.queries=h._updateApiQueries(m);var j=l.fields.filter(function(n){return null===f||0<=f.indexOf(n.name)});h.mutations=h._updateApiMutations(j),h._updateSyncList(m).then(function(n){return h.syncAll(n)}),delete h.pendingInit})}},{key:'_getType',value:function _getType(b){return this.schema.data.__schema.types.filter(function(c){return c.name===b})[0]}},{key:'_queryType',value:function _queryType(b,c){return this._typeQueryBuilders[b.kind](b,c)}},{key:'_updateSyncList',value:function _updateSyncList(b){var c=this;return new Promise(function(d){d(b.filter(function(f){return f.name in c.synced}))})}},{key:'_getTypeName',value:function _getTypeName(b,c){var d='';if('SCALAR'===b.kind)d=b.name;else{if('NON_NULL'===b.kind)return this._getTypeName(b.ofType,!0);d='LIST'===b.kind?'['+this._getTypeName(b.ofType)+']':b.name}return''+d+(c?'!':'')}},{key:'_prepareApiQuery',value:function _prepareApiQuery(b,c){var f=this,d=b.args.map(function(g){return{name:g.name,validator:f._typeValidators[g.type.kind]}}),e={queryBuilder:function queryBuilder(g,h){return(c?'mutation':'query')+' '+f._buildArgsDef(b,g)+' {\n\t\t\t\t'+b.name+f._buildArgs(b,g)+' '+f._queryType(b.type,h)+'\n\t\t\t}'},type:b.type};return{args:d,result:e}}},{key:'_buildArgsDef',value:function _buildArgsDef(b,c){var d=this;return''+(0<c.length?'('+b.args.filter(function(e){return e.name in c}).map(function(e){return'$'+e.name+':'+d._getTypeName(e.type)})+')':'')}},{key:'_buildArgs',value:function _buildArgs(b,c){return''+(0<c.length?'('+b.args.filter(function(d){return d.name in c}).map(function(d){return d.name+':$'+d.name})+')':'')}},{key:'_updateApiQueries',value:function _updateApiQueries(b){var c={},_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var f,d,e=b[Symbol.iterator]();!(_iteratorNormalCompletion=(f=e.next()).done);_iteratorNormalCompletion=!0)d=f.value,c[d.name]=this._prepareApiQuery(d)}catch(g){_didIteratorError=!0,_iteratorError=g}finally{try{!_iteratorNormalCompletion&&e.return&&e.return()}finally{if(_didIteratorError)throw _iteratorError}}return c}},{key:'_updateApiMutations',value:function _updateApiMutations(b){var c={},_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var f,d,e=b[Symbol.iterator]();!(_iteratorNormalCompletion2=(f=e.next()).done);_iteratorNormalCompletion2=!0)d=f.value,c[d.name]=this._prepareApiQuery(d,!0)}catch(g){_didIteratorError2=!0,_iteratorError2=g}finally{try{!_iteratorNormalCompletion2&&e.return&&e.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return c}}]),a}();exports.default=GraphqlClient;