"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_client=require("./client.min"),_client2=_interopRequireDefault(_client);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var GraphqlClient=function(){function a(b){var c=b.apiUrl,d=void 0===c?"/graphql":c,e=b.reqParams,f=void 0===e?{}:e,g=b.schemaUrl,h=void 0===g?"/schema.json":g,j=b.baseQueryName,k=void 0===j?"Query":j,l=b.baseMutationName,m=void 0===l?"Mutation":l,n=b.onlyQueries,o=void 0===n?null:n,p=b.onlyMutations,q=void 0===p?null:p,r=b.synced,s=void 0===r?[]:r,t=b.onData,u=void 0===t?function(){}:t,v=b.onError,w=void 0===v?function(){}:v;_classCallCheck(this,a),this.apiUrl=d,this.params=f,this.onData=u,this.onError=w,this._client=(0,_client2.default)(this.apiUrl,this.params),this._init(h,k,m,o,q,s)}return _createClass(a,[{key:"_typeQueryBuilders",get:function(){var c=this;return{SCALAR:function(){return""},NON_NULL:function(e){return e.ofType?c._queryType(e.ofType):""},ENUM:function(){return""},UNION:function(e){return e=c._getType(e.name),"{ "+e.possibleTypes.reduce(function(f,g){return f+(" ... on "+g.name+" "+c._queryType(g)+" ")},"")+" }"},OBJECT:function(e,f){var g=f?c._getType(e.name).fields.filter(function(j){return 0<=f.indexOf(j.name)}):c._getType(e.name).fields,h=g.reduce(function(j,k){return j+(k.name+" "+c._queryType(k.type))},"");return"{ "+h+" }\t"},LIST:function(e){return c._queryType(e.ofType)}}}},{key:"_typeValidators",get:function(){return{SCALAR:function(d){return"object"!==("undefined"==typeof d?"undefined":_typeof(d))},NON_NULL:function(d){return null!==d&&void 0!==d},ENUM:function(){return!0},UNION:function(){return!0},OBJECT:function(d){return"object"===("undefined"==typeof d?"undefined":_typeof(d))},LIST:function(d){return Array.isArray(d)}}}},{key:"go",get:function(){var c=this;return function(){return c._client.apply(c,arguments).then(function(d){return c.onData(d),d}).catch(function(d){throw c.onError(d),d})}}}]),_createClass(a,[{key:"mutate",value:function(c,d){var e=this,f=function(){try{return e.go(e.mutations[c].result.query,d)}catch(h){console.error("Trying to perform mutation "+c+" that does not exist.")}};return this.pendingInit?this.pendingInit.then(f):f()}},{key:"query",value:function(c,d,e){var f=this,g=function(){try{return f.go(e?f.queries[c].result.queryBuilder(e):f.queries[c].result.query,d)}catch(j){console.error("Trying to query "+c+" that does not exist.")}};return this.pendingInit?this.pendingInit.then(g):g()}},{key:"sync",value:function(c){var d="{ "+c.name+" "+this._queryType(c.type)+" }";return this.go(d,{})}},{key:"syncAll",value:function(c){var d=this;if(0<c.length){var e="{ "+c.reduce(function(f,g){return f+(" "+g.name+" "+d._queryType(g.type)+" ")},"")+" }";return this.go(e,{})}}},{key:"_init",value:function(c,d,e,f,g,h){var j=this;this.synced=h,this.pendingInit=fetch(c).then(function(k){return k.json()}).then(function(k){return j.schema=k}).then(function(){var k=j._getType(d),l=j._getType(e),m=k.fields.filter(function(o){return null===f||0<=f.indexOf(o.name)});j.queries=j._updateApiQueries(m);var n=l.fields.filter(function(o){return null===g||0<=g.indexOf(o.name)});j.mutations=j._updateApiMutations(n),j._updateSyncList(m).then(function(o){return j.syncAll(o)}),delete j.pendingInit})}},{key:"_getType",value:function(c){return this.schema.data.__schema.types.filter(function(d){return d.name===c})[0]}},{key:"_queryType",value:function(c,d){return this._typeQueryBuilders[c.kind](c,d)}},{key:"_updateSyncList",value:function(c){var d=this;return new Promise(function(e){e(c.filter(function(g){return g.name in d.synced}))})}},{key:"_getTypeName",value:function(c,d){var e="";if("SCALAR"===c.kind)e=c.name;else{if("NON_NULL"===c.kind)return this._getTypeName(c.ofType,!0);e="LIST"===c.kind?"["+this._getTypeName(c.ofType)+"]":c.name}return""+e+(d?"!":"")}},{key:"_prepareApiQuery",value:function(c,d){var e=this,f=c.args.map(function(h){return{name:h.name,validator:e._typeValidators[h.type.kind]}}),g={query:""+(d?"mutation":"query")+(0<c.args.length?"("+c.args.map(function(h){return"$"+h.name+":"+e._getTypeName(h.type)})+")":"")+" {\n\t\t\t"+c.name+(0<c.args.length?"("+c.args.map(function(h){return h.name+":$"+h.name})+")":"")+" "+this._queryType(c.type)+"\n\t\t\t}",queryBuilder:function(j){return""+(d?"mutation":"query")+(0<c.args.length?"("+c.args.map(function(k){return"$"+k.name+":"+e._getTypeName(k.type)})+")":"")+" {\n\t\t\t\t"+c.name+(0<c.args.length?"("+c.args.map(function(k){return k.name+":$"+k.name})+")":"")+" "+e._queryType(c.type,j)+"\n\t\t\t}"},type:c.type};return{args:f,result:g}}},{key:"_updateApiQueries",value:function(c){var g,d={},e=!0,f=!1;try{for(var j,k,h=c[Symbol.iterator]();!(e=(j=h.next()).done);e=!0)k=j.value,d[k.name]=this._prepareApiQuery(k)}catch(l){f=!0,g=l}finally{try{!e&&h.return&&h.return()}finally{if(f)throw g}}return d}},{key:"_updateApiMutations",value:function(c){var g,d={},e=!0,f=!1;try{for(var j,k,h=c[Symbol.iterator]();!(e=(j=h.next()).done);e=!0)k=j.value,d[k.name]=this._prepareApiQuery(k,!0)}catch(l){f=!0,g=l}finally{try{!e&&h.return&&h.return()}finally{if(f)throw g}}return d}}]),a}();exports.default=GraphqlClient;